{"version":3,"sources":["com/wsscode/pathom/profile.cljc"],"mappings":"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","names":["com.wsscode.pathom.profile/append-at","cur","v","cljs.core/map?","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","com.wsscode.pathom.profile/current-time-ms","js/Date","com.wsscode.pathom.profile/profile-plugin","parser","env","tx","G__48862","G__48863","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","reader","p__48873","map__48874","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","profile*","path","cljs.core/deref","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","com.wsscode.pathom.core/key-dispatch","start-time","res__44797__auto__","com.wsscode.common.async-cljs/chan?","c__38971__auto__","cljs.core.async.chan.cljs$core$IFn$_invoke$arity$1","cljs.core.async.impl.dispatch/run","f__38972__auto__","switch__38924__auto__","state_48910","state_val_48911","statearr-48924","inst_48908","cljs.core.async.impl.ioc-helpers/return-chan","inst_48886","statearr-48928","cljs.core.async.impl.ioc-helpers/process-exception","_","cljs.core.async.impl.ioc-helpers/add-exception-frame","cljs.core.async.impl.ioc-helpers/take!","inst_48892","inst_48893","com.wsscode.common.async-cljs/throw-err","statearr-48932","statearr-48937","inst_48905","statearr-48943","statearr-48944","inst_48894","statearr-48945","statearr-48946","inst_48901","inst_48902","inst_48903","statearr-48951","statearr-48958","state-machine__38925__auto__","ret-value__38926__auto__","result__38927__auto__","cljs.core/keyword-identical?","e48964","js/Object","ex__38928__auto__","statearr-48966","state__38973__auto__","statearr-48968","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","res","e48969","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$variadic","cljs.core/update-in","mutate","p__48973","map__48974","k","params","out","G__48993","cljs.core.update.cljs$core$IFn$_invoke$arity$3","action","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc","com.wsscode.pathom.profile/node-name","x","cljs.core/vector?","clojure.string.join.cljs$core$IFn$_invoke$arity$2","cljs.core.map.cljs$core$IFn$_invoke$arity$2","com.wsscode.pathom.profile/node-value","or__4131__auto__","cljs.core/+","cljs.core/vals","com.wsscode.pathom.profile/profile->nvc*","m","cljs.core.into.cljs$core$IFn$_invoke$arity$3","cljs.core.comp.cljs$core$IFn$_invoke$arity$2","p1__49078#","cljs.core.remove.cljs$core$IFn$_invoke$arity$1","cljs.core/first","cljs.core.map.cljs$core$IFn$_invoke$arity$1","p__49089","vec__49091","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","G__49095","com.wsscode.pathom.profile/profile->nvc","data","total","com.wsscode.pathom.profile/profile->flame-graph"],"sourcesContent":["(ns com.wsscode.pathom.profile\n  (:require\n    [clojure.string :as str]\n    [clojure.core.async :refer [<! go chan put!]]\n    [#?(:clj  com.wsscode.common.async-clj\n        :cljs com.wsscode.common.async-cljs) :refer [let-chan]]\n    [com.wsscode.pathom.core :as p]))\n\n(defn- append-at [cur v]\n  (cond\n    (map? cur)\n    (assoc cur ::self v)\n\n    :else\n    v))\n\n(defn current-time-ms []\n  #?(:clj  (System/currentTimeMillis)\n     :cljs (.getTime (js/Date.))))\n\n(def profile-plugin\n  {::p/wrap-parser\n   (fn profile-plugin-wrap-parser [parser]\n     (fn profile-plugin-wrap-parser-internal [env tx]\n       (parser (assoc env ::profile* (atom {})) tx)))\n\n   ::p/wrap-read\n   (fn profile-plugin-wrap-read [reader]\n     (fn profile-plugin-wrap-read-internal\n       [{::keys [profile*] ::p/keys [path] :as env}]\n       (if (= ::profile (p/key-dispatch env))\n         @profile*\n         (let [start-time (current-time-ms)]\n           (let-chan [res (reader env)]\n             (try\n               (swap! profile* update-in path append-at\n                 (- (current-time-ms) start-time))\n               (catch #?(:clj Throwable :cljs :default) _))\n             res)))))\n\n   ::p/wrap-mutate\n   (fn profile-plugin-wrap-mutate [mutate]\n     (fn profile-plugin-wrap-mutate-internal\n       [{::keys [profile*] :as env} k params]\n       (let [out (mutate env k params)]\n         (cond-> out\n           (:action out)\n           (update :action\n             (fn [action]\n               (fn []\n                 (let [start-time (current-time-ms)\n                       res        (action)]\n                   (swap! profile* assoc k (- (current-time-ms) start-time))\n                   res))))))))})\n\n;; Helper computing functions\n\n(defn node-name [x]\n  (cond\n    (vector? x) (str/join \"_\" (map node-name x))\n    :else (str x)))\n\n(defn node-value [x]\n  (if (map? x)\n    (or (::self x) (apply + (map node-value (vals x))))\n    x))\n\n;; Flame graph conversion\n\n(defn profile->nvc* [m]\n  (->> m\n       (into [] (comp (remove #(= ::self (first %)))\n                      (map (fn [[k v]]\n                             (cond-> {:name (node-name k) :value (node-value v)}\n                               (map? v) (assoc :children (profile->nvc* v)))))))))\n\n(defn profile->nvc\n  \"Convert data into format of maps containg the keys:\n    name: the current attribute name\n    value: the total time spent on the node + children\n    children: the children elements (recursive)\n\n   This for is suitable for some d3 flamegraph plugins on the browser\"\n  [data]\n  (let [total (apply + (map node-value (vals data)))]\n    {:name     \"Root\"\n     :value    total\n     :children (profile->nvc* data)}))\n\n;; DEPRECATED\n\n; old name, kept for compatibility\n(def profile->flame-graph profile->nvc)\n"]}