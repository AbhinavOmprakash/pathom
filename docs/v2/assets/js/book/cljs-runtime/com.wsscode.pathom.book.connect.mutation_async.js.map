{"version":3,"sources":["com/wsscode/pathom/book/connect/mutation_async.cljs"],"mappings":"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","names":["com.wsscode.pathom.book.connect.mutation-async/adapt-user","user","cljs.core.into.cljs$core$IFn$_invoke$arity$3","cljs.core.map.cljs$core$IFn$_invoke$arity$1","p__53713","vec__53722","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","k","v","cljs.core.keyword.cljs$core$IFn$_invoke$arity$2","cljs.core/name","cljs.core.dissoc.cljs$core$IFn$_invoke$arity$2","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","com.wsscode.pathom.connect/mutation","p__53742","map__53744","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","com.wsscode.pathom.book.connect.mutation-async/user-create","db","c__39003__auto__","cljs.core.async.chan.cljs$core$IFn$_invoke$arity$1","cljs.core.async.impl.dispatch/run","f__39004__auto__","switch__38929__auto__","state_53793","state_val_53794","cljs.core.async.impl.ioc-helpers/take!","inst_53751","inst_53752","com.wsscode.common.async-cljs/throw-err","inst_53754","inst_53757","inst_53759","cljs.core/PersistentHashMap","inst_53763","cljs.core/PersistentVector","inst_53766","inst_53767","inst_53768","inst_53770","inst_53773","js/Date","inst_53774","inst_53775","inst_53776","inst_53777","inst_53779","inst_53780","inst_53782","inst_53785","inst_53786","inst_53787","inst_53788","inst_53789","inst_53790","cljs.core.async.impl.ioc-helpers/return-chan","statearr-53856","state-machine__38930__auto__","ret-value__38931__auto__","result__38932__auto__","cljs.core/keyword-identical?","e53865","js/Object","ex__38933__auto__","statearr-53866","cljs.core.async.impl.ioc-helpers/process-exception","state__39005__auto__","statearr-53867","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","cljs.core/select-keys","cljs.core.merge.cljs$core$IFn$_invoke$arity$variadic","com.wsscode.pathom.book.util.indexeddb/create!","com.wsscode.pathom.connect/resolver","p__53868","p__53869","map__53870","map__53871","com.wsscode.pathom.book.connect.mutation-async/user-by-id","id","state_53886","state_val_53887","inst_53875","inst_53876","inst_53877","inst_53878","inst_53879","inst_53880","inst_53882","inst_53883","inst_53884","statearr-53888","e53889","statearr-53890","statearr-53891","com.wsscode.pathom.book.util.indexeddb/read-object","p__53893","map__53894","com.wsscode.pathom.book.connect.mutation-async/all-users","_","state_53933","state_val_53934","inst_53901","inst_53902","inst_53903","inst_53920","inst_53921","inst_53922","inst_53923","inst_53924","inst_53925","statearr-53937","inst_53927","inst_53928","inst_53929","inst_53930","inst_53931","statearr-53938","e53939","statearr-53940","statearr-53941","com.wsscode.pathom.book.util.indexeddb/scan-store","cljs.core.async/into","cljs.core.mapv.cljs$core$IFn$_invoke$arity$2","com.wsscode.pathom.book.connect.mutation-async/app-registry","com.wsscode.pathom.book.connect.mutation-async/db-settings","com.wsscode.pathom.book.connect.mutation-async/parser","com.wsscode.pathom.core/parallel-parser","com.wsscode.pathom.core/map-reader","com.wsscode.pathom.connect/parallel-reader","com.wsscode.pathom.connect/open-ident-reader","com.wsscode.pathom.core/env-placeholder-reader","com.wsscode.pathom.book.util.indexeddb/setup-db","com.wsscode.pathom.connect/mutate-async","com.wsscode.pathom.connect.connect_plugin.cljs$core$IFn$_invoke$arity$1","com.wsscode.pathom.core/error-handler-plugin","com.wsscode.pathom.core/trace-plugin"],"sourcesContent":["(ns com.wsscode.pathom.book.connect.mutation-async\n  (:require [cljs.core.async :as async :refer [go]]\n            [com.wsscode.common.async-cljs :refer [go-catch <!p <?]]\n            [com.wsscode.pathom.book.util.indexeddb :as db]\n            [com.wsscode.pathom.connect :as pc]\n            [com.wsscode.pathom.core :as p]))\n\n(defn adapt-user [user]\n  (-> (into {} (map (fn [[k v]] [(keyword \"user\" (name k)) v])) (dissoc user ::db/key))\n      (assoc :user/id (::db/key user))))\n\n(pc/defmutation user-create [{::keys [db]} user]\n  {::pc/sym    'user/create\n   ::pc/params [:user/name :user/email]\n   ::pc/output [:user/id]}\n  (go\n    (let [db      (<? db)\n          user-id (-> user\n                      (select-keys [:user/name :user/email])\n                      (merge {:user/created-at (js/Date.)})\n                      (->> (db/create! {::db/db db ::db/store-name \"users\"}))\n                      <?)]\n      {:user/id       user-id\n       :app/id-remaps {(:user/id user) user-id}})))\n\n(pc/defresolver user-by-id [{::keys [db]} {:keys [user/id]}]\n  {::pc/input  #{:user/id}\n   ::pc/output [:user/id :user/name :user/email :user/created-at]}\n  (go\n    ; reading from indexeddb\n    (let [db (<? db)]\n      (-> (db/read-object {::db/db db ::db/store-name \"users\"} id) <?\n          adapt-user))))\n\n; let's make an access to all users\n(pc/defresolver all-users [{::keys [db]} _]\n  {::pc/output [{:user/all [:user/id :user/name :user/email :user/created-at]}]}\n  (go\n    (let [db (<? db)]\n      (->> (db/scan-store {::db/db db ::db/store-name \"users\"})\n           (async/into []) <?\n           (mapv adapt-user)\n           (hash-map :user/all)))))\n\n; list all our app resolvers and mutations\n(def app-registry [user-create user-by-id all-users])\n\n(def db-settings\n  {::db/db-name    \"connectAsyncDemo\"\n   ::db/migrations [{::db/stores {\"users\" {::db/keys    ::db/auto-increment\n                                           ::db/indexes {\"name\" {::db/unique false}}}}}]})\n\n(def parser\n  (p/parallel-parser\n    {::p/env     {::p/reader               [p/map-reader\n                                            pc/parallel-reader\n                                            pc/open-ident-reader\n                                            p/env-placeholder-reader]\n                  ::p/placeholder-prefixes #{\">\"}\n                  ::pc/mutation-join-globals [:app/id-remaps]\n                  ::db                       (db/setup-db db-settings)}\n     ::p/mutate  pc/mutate-async\n     ::p/plugins [(pc/connect-plugin {::pc/register app-registry})\n                  p/error-handler-plugin\n                  p/trace-plugin]}))\n"]}